<!DOCTYPE html>
<html lang="ko"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Store - 마이페이지</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
</head>
<body>
<header class="header">
    <div class="container">
        <div class="logo">
            <h1><a th:href="@{/home}">Fashion Store</a></h1>
        </div>
        <nav class="nav">
            <div class="d-flex align-items-center gap-3">

                <!-- 로그인 상태에 따라 표시 -->
                <div sec:authorize="!isAuthenticated()">
                    <button class="btn btn-outline-success btn-sm" onclick="goToLogin()" id="loginBtn">로그인</button>
                </div>
                <div sec:authorize="isAuthenticated()">
                    <button class="btn btn-outline-danger btn-sm" onclick="goToLogout()" id="logoutBtn">로그아웃</button>
                </div>
            </div>
        </nav>
    </div>
</header>

<main class="main">
    <div class="container">
        <div class="mypage-container">
            <h2>마이페이지</h2>
            <div class="mypage-content">
                <div class="user-info">
                    <h3>회원 정보</h3>
                    <div id="userInfo">
                        <!-- 사용자 정보가 JavaScript로 동적 생성됩니다 -->
                    </div>
                    <a href="/userInfo-update" class="btn btn-primary edit-btn">정보 수정</a>
                </div>
                <div class="order-history">
                    <h3>주문 내역</h3>
                    <div id="orderHistory">
                        <!-- 주문 내역이 JavaScript로 동적 생성됩니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script th:src="@{/js/script.js}"></script>
<script>
    function displayUserInfo() {
        fetch('/api/members/me', {credentials: 'include'})
            .then(res => {
                if (res.status === 401) {
                    alert('로그인이 필요합니다.');
                    window.location.href = '/login';
                    return;
                }
                if (!res.ok) throw new Error('사용자 정보를 불러올 수 없습니다.');
                return res.json();
            })
            .then(user => {
                if (!user) return;
                const userInfo = document.getElementById('userInfo');
                if (!userInfo) return;
                userInfo.innerHTML = `
            <div class="user-detail"><strong>이름:</strong> ${user.userName}</div>
            <div class="user-detail"><strong>이메일:</strong> ${user.email}</div>
            <div class="user-detail"><strong>전화번호:</strong> ${user.phone}</div>
            <div class="user-detail"><strong>생일:</strong>${user.birthDate ? new Date(user.birthDate).toLocaleDateString() : '미등록'}</div>
        `;
            })
            .catch(err => {
                console.error(err);
                alert('사용자 정보를 불러오는 데 실패했습니다.');
            });
    }


    // 주문 내역 표시 (mypage.html)
    function displayOrderHistory() {
        fetch('/api/orders', {credentials: 'include'})
            .then(res => {
                if (res.status === 401) {
                    alert('로그인이 필요합니다.');
                    window.location.href = '/login';
                    return;
                }
                if (!res.ok) throw new Error('주문 내역을 불러올 수 없습니다.');
                return res.json();
            })
            .then(orders => {
                if (!orders) return;
                const orderHistory = document.getElementById('orderHistory');
                if (!orderHistory) return;
                if (orders.length === 0) {
                    orderHistory.innerHTML = '<p>주문 내역이 없습니다.</p>';
                    return;
                }
                orderHistory.innerHTML = '';
                orders.reverse().forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    const itemList = order.orderItems.map(item => `${item.productName} x ${item.quantity}`).join(', ');
                    orderItem.innerHTML = `
                <div class="order-date">주문일: ${order.formattedDate}</div>
                <div class="order-items">${itemList}</div>
                <div class="order-total">총 금액: ${order.totalPrice.toLocaleString()}원</div>
                <div class="order-address">배송지 : ${order.address},${order.addressDetail}</div>
            `;
                    orderHistory.appendChild(orderItem);
                });
            })
            .catch(err => {
                console.error(err);
                alert('주문 내역을 불러오는 데 실패했습니다.');
            });
    }

    // 페이지 로딩 시 사용자 정보 및 주문 내역 표시
    document.addEventListener('DOMContentLoaded', () => {
        displayUserInfo();
        displayOrderHistory();
    });


    // ====================================================================================================
    // 네비게이션 함수들 (모든 HTML 페이지의 네비게이션 버튼에서 사용)
    // ====================================================================================================

</script>
</body>
</html>